<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BitLoTop Airdrop</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; background:#f7fafc; padding:20px; color:#111; }
    .card { background:#fff; max-width:980px; margin:20px auto; padding:20px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    input, textarea, button, select { font-size:14px; }
    textarea { width:100%; min-height:160px; }
    .row { display:flex; gap:12px; align-items:center; margin-top:10px; flex-wrap:wrap; }
    .muted { color:#666; font-size:13px; }
    .log { white-space:pre-wrap; background:#0b1220; color:#e6f3ff; padding:12px; border-radius:8px; max-height:300px; overflow:auto; }
    label { font-weight:600; }
    .summary { background:#f1f5f9; padding:10px; border-radius:8px; }
    .small { font-size:13px; color:#555; }
    .btn { padding:8px 12px; border-radius:6px; cursor:pointer; }
    .btn-primary { background:#16a34a; color:#fff; border:none; }
    .btn-ghost { background:#e2e8f0; border:none; }
  </style>
</head>
<body>
  <div class="card">
    <h1>BitLoTop Airdrop</h1>
    <p class="muted">Private airdrop tool — sequential sends but with batch preview & gas estimation. Test with a few addresses first.</p>

    <div class="row">
      <button id="btnConnect" class="btn btn-ghost">Connect Wallet</button>
      <div id="account" class="small">Not connected</div>
      <div id="balances" class="small" style="margin-left:auto"></div>
    </div>

    <!-- ✅ RPC and Gas controls -->
    <div style="margin-top:10px; border:1px solid #e2e8f0; padding:10px; border-radius:8px;">
      <label>RPC Endpoint</label>
      <select id="rpcSelect" style="width:100%;margin-bottom:6px;">
        <option value="https://bsc-dataseed.binance.org">Default — Binance RPC</option>
        <option value="https://bsc-dataseed1.defibit.io">Defibit RPC</option>
        <option value="https://bsc-dataseed1.ninicoin.io">Ninicoin RPC</option>
        <option value="https://bsc-dataseed1.bnbchain.org">BNBChain RPC</option>
        <option value="">Custom (paste below)</option>
      </select>
      <input id="rpcCustom" placeholder="https://your-rpc-url.com" style="width:100%;margin-bottom:6px;">
      <label>Manual Gas Price (Gwei)</label>
      <input id="manualGas" type="number" step="0.1" placeholder="Auto" style="width:100%;">
    </div>
    <!-- end RPC/GAS controls -->

    <hr/>

    <div>
      <label>Token to send</label>
      <div class="row" style="align-items:center">
        <select id="tokenSelect">
          <option value="0x8a128ae8823202e3ad53431319034a2ede9be9cc">BitLoTop — 0x8a128a...9be9cc</option>
          <option value="">Custom token (paste address)</option>
        </select>
        <input id="tokenAddress" placeholder="0x..." style="flex:1; padding:8px; border-radius:6px; border:1px solid #ddd;" value="0x8a128ae8823202e3ad53431319034a2ede9be9cc" />
        <button id="btnLoadToken" class="btn btn-ghost">Load token</button>
      </div>
      <div class="row" style="margin-top:8px;">
        <div class="muted">Symbol: <span id="tokenSymbol">BitLoTop</span></div>
        <div class="muted" style="margin-left:12px">Decimals: <span id="tokenDecimals">18</span></div>
        <div class="muted" style="margin-left:12px">Your token balance: <span id="tokenBalance">-</span></div>
      </div>
    </div>

    <hr/>

    <div>
      <label>Upload CSV (address,amount) or paste below:</label><br/>
      <input id="file" type="file" accept=".csv,.txt" />
      <textarea id="csv" placeholder="0xabc...,1.0
0xdef...,2.5"></textarea>
      <div class="row" style="margin-top:8px;">
        <div>Recipients: <b id="count">0</b></div>
        <div>Total tokens to send: <b id="total">0</b></div>
        <div>Estimated gas per tx: <b id="estGas">-</b></div>
        <div style="margin-left:auto"><button id="btnPreview" class="btn btn-ghost">Preview</button> <button id="btnStart" class="btn btn-primary">Start Airdrop</button></div>
      </div>
      <div class="muted" style="margin-top:6px">You can select the token above or paste any BEP-20 token address. The UI will fetch symbol/decimals and your token balance.</div>
    </div>

    <hr/>

    <div>
      <h3>Logs</h3>
      <div id="log" class="log">Waiting for action...</div>
    </div>

    <hr/>

    <div class="summary">
      <strong>Summary</strong>
      <div id="summaryText" class="small">No preview yet.</div>
    </div>

    <div style="margin-top:12px" class="small muted">This page is static and runs in the browser. It does <em>sequential</em> transfers (one transaction per recipient).</div>
  </div>

<script>
// === Added helpers for RPC/GAS ===
function getRpcUrl() {
  const sel = document.getElementById('rpcSelect')?.value?.trim() || '';
  const custom = document.getElementById('rpcCustom')?.value?.trim() || '';
  return custom || sel || 'https://bsc-dataseed.binance.org';
}
function getManualGasWei() {
  const val = document.getElementById('manualGas')?.value?.trim();
  if (!val) return null;
  const gwei = parseFloat(val);
  if (isNaN(gwei) || gwei <= 0) return null;
  return '0x' + (BigInt(Math.round(gwei * 1e9))).toString(16);
}
// ================================

const logEl = document.getElementById('log');
function log(...args){ logEl.textContent += "\n" + args.join(' '); logEl.scrollTop = logEl.scrollHeight; }
function clearLog(){ logEl.textContent = ''; }

let provider = null;
let account = null;

async function connect() {
  if(!window.ethereum){ alert('MetaMask or other injected wallet required'); return; }
  provider = window.ethereum;
  try {
    const accounts = await provider.request({ method: 'eth_requestAccounts' });
    account = accounts[0];
    document.getElementById('account').textContent = 'Connected: ' + account;
    log('Connected', account);
    await refreshBalances();
  } catch(e) {
    log('Connection failed', e.message || e);
  }
}

document.getElementById('btnConnect').onclick = connect;

// === RPC reconnect on change ===
document.getElementById('rpcSelect').addEventListener('change', ()=>{
  log('RPC changed to', getRpcUrl());
});
document.getElementById('rpcCustom').addEventListener('input', ()=>{
  log('Custom RPC set to', getRpcUrl());
});
// ================================

async function refreshBalances(){
  if(!account) return;
  try {
    const rpc = getRpcUrl();
    const rpcProvider = { request: (args)=>window.ethereum.request(args) }; // fallback still MetaMask
    const bnb = await provider.request({ method:'eth_getBalance', params:[account, 'latest'] });
    const bnbEth = parseInt(bnb,16) / (10**18);
    document.getElementById('balances').textContent = 'BNB: ' + bnbEth.toFixed(6);
  } catch(e){ log('BNB balance error', e.message || e); }
  await loadTokenInfo();
}

// ... your existing token & send functions below stay unchanged ...

async function sendAirdrop(){
  const list = parseList();
  if(!list.length){ alert('No recipients'); return; }
  if(!account){ alert('Connect wallet first'); return; }
  const tokenAddr = document.getElementById('tokenAddress').value.trim();
  const dec = parseInt(document.getElementById('tokenDecimals').textContent || '18');
  const manualGas = getManualGasWei();
  if(!confirm(`Send to ${list.length} recipients? This will create ${list.length} transactions.`)) return;
  for(const r of list){
    const method = 'a9059cbb';
    const toP = strip0x(r.address).padStart(64,'0');
    const parts = r.amount.split('.');
    let whole = BigInt(parts[0]||'0'); let frac='0';
    if(parts[1]) frac=parts[1].padEnd(dec,'0').slice(0,dec);
    const amount = whole*BigInt(10)**BigInt(dec)+BigInt(frac);
    const data = '0x'+method+toP+amount.toString(16).padStart(64,'0');
    const txParams={ from:account,to:tokenAddr,data:data };
    if(manualGas){ txParams.gasPrice=manualGas; log('Using manual gas price:',manualGas); }
    try{
      const est=await provider.request({method:'eth_estimateGas',params:[txParams]});
      txParams.gas=est;
    }catch(e){}
    const txHash=await provider.request({method:'eth_sendTransaction',params:[txParams]});
    log('Tx sent:',txHash);
    await waitForTx(txHash);
    log('Confirmed:',txHash);
  }
  log('Airdrop complete.');
}
</script>
</body>
</html>
