<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="robots" content="noindex" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BitLoTop Airdorp</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; background:#f7fafc; padding:20px; color:#111; }
    .card { background:#fff; max-width:900px; margin:20px auto; padding:20px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    input, textarea, button { font-size:14px; }
    textarea { width:100%; min-height:180px; }
    .row { display:flex; gap:12px; align-items:center; margin-top:10px; }
    .muted { color:#666; font-size:13px; }
    .log { white-space:pre-wrap; background:#0f172a; color:#e6f3ff; padding:12px; border-radius:8px; max-height:300px; overflow:auto; }
    .danger { color:#b91c1c; font-weight:600; }
  </style>
</head>
<body>
  <div class="card">
    <h1>BitLoTop Airdorp</h1>
    <p class="muted">Sequential airdrop tool — sends token transfers one-by-one from the connected wallet. Use small test list first. Token preconfigured for BitLoTop.</p>

    <div>
      <label>Token contract (BEP-20):</label><br/>
      <input id="tokenAddress" style="width:100%; padding:8px; margin-top:6px;" value="0x8a128ae8823202e3ad53431319034a2ede9be9cc" />
      <div class="muted">Symbol: <span id="tokenSymbol">BitLoTop</span> • Decimals: <span id="decimals">18</span></div>
      <div style="margin-top:8px;">
        <button id="btnLoad" style="padding:8px 12px">Load token info</button>
        <button id="btnAdd" style="padding:8px 12px">Add token to wallet</button>
      </div>
    </div>

    <hr/>

    <div>
      <label>Upload CSV (address,amount) or paste below:</label><br/>
      <input id="file" type="file" accept=".csv,.txt" />
      <textarea id="csv" placeholder="0xabc...,1.0
0xdef...,2.5"></textarea>
      <div class="row">
        <div>Parsed recipients: <b id="count">0</b></div>
        <div><button id="btnPreview" style="padding:8px 10px">Preview</button></div>
        <div><button id="btnStart" style="padding:8px 10px">Start Airdrop (sequential)</button></div>
      </div>
    </div>

    <hr/>

    <div>
      <h3>Logs</h3>
      <div id="log" class="log">Not connected.</div>
    </div>

    <hr/>
    <div class="muted">Notes: This performs one on-chain transfer per recipient. It is simple but can be expensive for large lists. Test with 2-3 addresses first. Make sure the connected wallet has enough tokens and BNB for gas.</div>
  </div>

<script type="module">
import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.esm.min.js";

const logEl = document.getElementById('log');
function log(...args){ logEl.textContent += "\n" + args.join(' '); logEl.scrollTop = logEl.scrollHeight; }

let provider = null;
let signer = null;

async function ensureProvider(){
  if(window.ethereum){
    provider = new ethers.BrowserProvider(window.ethereum);
    try{
      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      const addr = await signer.getAddress();
      log('Connected', addr);
    }catch(e){
      log('Connection rejected or error', e.message || e);
    }
  }else{
    log('No injected wallet found (install MetaMask).');
  }
}

document.getElementById('btnLoad').onclick = async ()=>{
  await ensureProvider();
  const t = document.getElementById('tokenAddress').value.trim();
  if(!ethers.isAddress(t)){ log('Invalid token address'); return; }
  try{
    const token = new ethers.Contract(t, ['function symbol() view returns (string)','function decimals() view returns (uint8)'], provider);
    const s = await token.symbol();
    const d = await token.decimals();
    document.getElementById('tokenSymbol').textContent = s;
    document.getElementById('decimals').textContent = d.toString();
    log('Token loaded', s, 'decimals', d.toString());
  }catch(e){
    log('Unable to load token info', e.message || e);
  }
};

document.getElementById('btnAdd').onclick = async ()=>{
  const t = document.getElementById('tokenAddress').value.trim();
  const symbol = document.getElementById('tokenSymbol').textContent || 'TKN';
  const decimals = parseInt(document.getElementById('decimals').textContent || '18');
  if(!window.ethereum){ log('No MetaMask'); return; }
  try{
    await window.ethereum.request({
      method: 'wallet_watchAsset',
      params: { type: 'ERC20', options: { address: t, symbol: symbol, decimals: decimals, image: '' } },
    });
    log('Token suggested to wallet');
  }catch(e){ log('Add token failed', e.message || e); }
};

document.getElementById('file').onchange = (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = (ev)=>{ document.getElementById('csv').value = ev.target.result; parseAndShow(); };
  r.readAsText(f);
};

function parseAndShow(){
  const text = document.getElementById('csv').value.trim();
  if(!text){ document.getElementById('count').textContent = '0'; return []; }
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const parsed = [];
  for(const line of lines){
    const parts = line.split(/[,\s]+/).map(p=>p.trim());
    if(parts.length < 2) continue;
    const addr = parts[0], amt = parts[1];
    if(!ethers.isAddress(addr)){ log('Skipping invalid address', addr); continue; }
    if(isNaN(Number(amt))){ log('Skipping invalid amount', amt); continue; }
    parsed.push({address: addr, amount: amt});
  }
  document.getElementById('count').textContent = parsed.length.toString();
  return parsed;
}

document.getElementById('btnPreview').onclick = ()=>{ const p = parseAndShow(); log('Preview', p.length, 'recipients'); };

document.getElementById('btnStart').onclick = async ()=>{
  const list = parseAndShow();
  if(!list.length){ log('No recipients'); return; }
  await ensureProvider();
  if(!signer){ log('Connect wallet first'); return; }
  const taddr = document.getElementById('tokenAddress').value.trim();
  const decimals = parseInt(document.getElementById('decimals').textContent || '18');
  const token = new ethers.Contract(taddr, ['function transfer(address to, uint256 value) public returns (bool)'], signer);
  log('Starting sequential sends', list.length, 'txs');
  for(let i=0;i<list.length;i++){
    const r = list[i];
    try{
      const value = ethers.parseUnits(r.amount, decimals);
      log(`Sending ${r.amount} to ${r.address} ...`);
      const tx = await token.transfer(r.address, value);
      log('Tx submitted:', tx.hash);
      await tx.wait();
      log('Confirmed:', tx.hash);
    }catch(e){
      log('Transfer failed at', r.address, e.message || e);
      return;
    }
  }
  log('All done.');
};

log('Page loaded. Use Load token to verify, then upload CSV and Start Airdrop.');
</script>

</body>
</html>
